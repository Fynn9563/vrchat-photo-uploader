name: 'Install System Dependencies'
description: 'Install system dependencies for Tauri builds across platforms'
inputs:
  os:
    description: 'Operating system (ubuntu, macos, windows)'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Install system dependencies (Ubuntu)
      if: inputs.os == 'ubuntu'
      shell: bash
      run: |
        echo "ðŸ”§ Installing system dependencies for Ubuntu..."
        
        # Update package list
        sudo apt-get update -qq
        
        # Install essential build tools first
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          curl \
          wget \
          file \
          libssl-dev
        
        # Install GTK and WebKit dependencies with version fallbacks
        sudo apt-get install -y \
          libgtk-3-dev \
          libappindicator3-dev \
          librsvg2-dev \
          patchelf
        
        # Install WebKit with version detection and compatibility links
        if sudo apt-get install -y libwebkit2gtk-4.1-dev; then
          echo "âœ… Installed libwebkit2gtk-4.1-dev"
          
          # Create compatibility symlinks for pkg-config
          if [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -sf \
              /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc \
              /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
            echo "âœ… Created webkit2gtk-4.0.pc compatibility link"
          fi
          
          # Create library symlinks for linker
          if [ ! -f /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so ]; then
            sudo ln -sf \
              /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so \
              /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so
            echo "âœ… Created libwebkit2gtk-4.0.so compatibility link"
          fi
          
        elif sudo apt-get install -y libwebkit2gtk-4.0-dev; then
          echo "âœ… Installed libwebkit2gtk-4.0-dev"
        else
          echo "âŒ Failed to install WebKit2GTK development packages"
          exit 1
        fi
        
        # Install GLib and related libraries
        sudo apt-get install -y \
          libglib2.0-dev \
          libgdk-pixbuf2.0-dev \
          libatk1.0-dev \
          libpango1.0-dev \
          libcairo2-dev \
          libcairo-gobject2 \
          libgdk-pixbuf-2.0-0 \
          libsoup2.4-dev
        
        # Install JavaScriptCore with version detection and compatibility links
        if sudo apt-get install -y libjavascriptcoregtk-4.1-dev; then
          echo "âœ… Installed libjavascriptcoregtk-4.1-dev"
          
          # Create compatibility symlinks for pkg-config
          if [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.0.pc ]; then
            sudo ln -sf \
              /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.1.pc \
              /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.0.pc
            echo "âœ… Created javascriptcoregtk-4.0.pc compatibility link"
          fi
          
          # Create library symlinks for linker  
          if [ ! -f /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so ]; then
            sudo ln -sf \
              /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so \
              /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so
            echo "âœ… Created libjavascriptcoregtk-4.0.so compatibility link"
          fi
          
        elif sudo apt-get install -y libjavascriptcoregtk-4.0-dev; then
          echo "âœ… Installed libjavascriptcoregtk-4.0-dev"
        else
          echo "âŒ Failed to install JavaScriptCore development packages"
          exit 1
        fi
        
        # Install additional Tauri dependencies
        sudo apt-get install -y \
          libxdo-dev \
          libxrandr2 \
          libxss1 \
          libxcursor1 \
          libxcomposite1 \
          libasound2-dev \
          libxdamage1 \
          libxext6 \
          libxfixes3 \
          libxi6 \
          libxrender1 \
          libcairo-gobject2 \
          libdbus-1-dev
        
        # Verify critical packages
        echo "âœ… Verifying installations..."
        pkg-config --exists glib-2.0 && echo "âœ… glib-2.0 found" || echo "âŒ glib-2.0 missing"
        pkg-config --exists gtk+-3.0 && echo "âœ… gtk+-3.0 found" || echo "âŒ gtk+-3.0 missing"
        
        # Check for WebKit (both versions)
        if pkg-config --exists webkit2gtk-4.1; then
          echo "âœ… webkit2gtk-4.1 found"
        else
          echo "âŒ webkit2gtk-4.1 missing"
        fi
        
        if pkg-config --exists webkit2gtk-4.0; then
          echo "âœ… webkit2gtk-4.0 found (required by Tauri)"
        else
          echo "âŒ webkit2gtk-4.0 missing (required by Tauri)"
        fi
        
        # Check for JavaScriptCore (both versions)
        if pkg-config --exists javascriptcoregtk-4.1; then
          echo "âœ… javascriptcoregtk-4.1 found"
        else
          echo "âŒ javascriptcoregtk-4.1 missing"
        fi
        
        if pkg-config --exists javascriptcoregtk-4.0; then
          echo "âœ… javascriptcoregtk-4.0 found (required by Rust crates)"
        else
          echo "âŒ javascriptcoregtk-4.0 missing (required by Rust crates)"
        fi
        
        # Debug pkg-config paths
        echo "ðŸ” PKG_CONFIG_PATH: ${PKG_CONFIG_PATH:-not set}"
        echo "ðŸ” Available WebKit/JSCore .pc files:"
        find /usr/lib -name "*webkit*.pc" -o -name "*javascript*.pc" 2>/dev/null | head -10 || echo "None found"
        
        echo "ðŸŽ‰ Ubuntu system dependencies installation completed!"

    - name: Install system dependencies (macOS)
      if: inputs.os == 'macos'
      shell: bash
      run: |
        echo "ðŸ”§ Installing system dependencies for macOS..."
        # macOS typically doesn't need additional system dependencies for Tauri
        echo "âœ… macOS dependencies check completed!"

    - name: Install system dependencies (Windows)
      if: inputs.os == 'windows'
      shell: bash
      run: |
        echo "ðŸ”§ Installing system dependencies for Windows..."
        # Windows typically doesn't need additional system dependencies for Tauri
        echo "âœ… Windows dependencies check completed!"